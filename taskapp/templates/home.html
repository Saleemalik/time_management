{% extends "base.html" %}
{% block content %}
<br>
<h1 class="text-center">Home PAGE</h1>
<h2 class="text-center">Welcome, {{request.user}}</h2>
<hr>
<br>
<br>
<div class="container-lg">
    <div>
        <div class="table-title w-auto">
            <div class="d-flex justify-content-between">
                <div>
                    <h2>Tasks <b>Details</b></h2>
                </div>
                <button class="btn btn-sm btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#createModal">New Task</button>
            </div>
            {% include "createTask.html" %}
            {% include "editTask.html" %}

            <!-- Modal -->
           
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>productid</th>
                    <th>title</th>
                    <th>description</th>
                    <th>priority</th>
                    <th>status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="task-body">


            </tbody>
        </table>
        <div class="text-center mt-3">
            <button id="prev-btn" class="btn btn-primary">Previous</button>
            <button id="next-btn" class="btn btn-primary">Next</button>
        </div>
        <!-- modal -->

    </div>
    <br>

    <script>
        const tbody = document.getElementById('task-body')
        let currentURL = '/api/tasks/'
        const getTasks = tasks => {
            tbody.innerHTML = ''
            tasks.forEach(task => {
                const row = document.createElement('tr')
                row.innerHTML = `
                <td>${task.id}</td>
                <td>${task.title}</td>
                <td>${task.description}</td>
                <td>${task.priority}</td>
                <td>${task.status}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editTask(${task.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                </td>
                    `
                tbody.appendChild(row)
            })
        }
        const updatePaginateBtn = (prev, next) => {
            const prevBtn = document.getElementById("prev-btn")
            const nextBtn = document.getElementById("next-btn")

            prevBtn.disabled = !prev
            nextBtn.disabled = !next

            if (prev) {
                prevBtn.onclick = () => {
                    currentURL = prev
                    LoadUserTasks()
                }
            }
            if (next) {
                nextBtn.onclick = () => {
                    currentURL = next
                    LoadUserTasks()
                }
            }

        }
        const LoadUserTasks = () => {
            axios.get(currentURL).then(response => {
                const tasks = response.data.results
                const previous = response.data.previous
                const next = response.data.next
                getTasks(tasks)
                updatePaginateBtn(previous, next)
            })

        }

        document.addEventListener('DOMContentLoaded', LoadUserTasks)

        const editTask = taskId => {
            axios.get(`/api/tasks/${taskId}/`)
            .then(response => {
                const task = response.data;
                document.getElementById('task-id').value = task.id;
                document.getElementById('edit-title').value = task.title;
                document.getElementById('edit-description').value = task.description;
                document.getElementById('edit-priority').value = task.priority;
                document.getElementById('edit-status').value = task.status;

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Failed to fetch task:', error);
                alert("Could not load task data.");
            });
        }


    </script>
    {% endblock %}